
# Clean up the configs.json generated by mongo command in dump_data.sh so that the 
# generated configs.json is backward compatible with the old format generated by
# mongoexport.

import sys
import json

def main(argv):
    if len(argv) != 3:
        print "Usage: " + argv[0] + " configs.json new_filename"
        exit(1)

    filename = argv[1]
    if filename[-5:] != ".json":
        print "Error: incorrect input file extension."
        exit(1)

    newFileName = argv[2]
    if newFileName == filename:
        print "Error: new_filename cannot be the same as configs.json."
        exit(1)

    res = []
    with open(filename, "r") as jsonfile:
        for line in jsonfile.readlines():
            if line[0] != "{": continue

            line = line.replace("ObjectId(", "").replace("ISODate(", "").replace(")", "");
            j = json.loads(line)
            j["_id"] = {"$oid" : j["id"]}
            j["created"] = {"$date" : j["created"]}
            j["__v"] = 0
            res.append(j)

    with open(newFileName, "w") as newFile:
      for o in res:
        json.dump(o, newFile)
        newFile.write("\n")
    

if __name__ == "__main__":
    main(sys.argv)
